{
    "collab_server" : "",
    "contents" : "#' Wrapper function generate VAST diagnostic and prediction plots\n#'\n#' @param Opt list output from Template Model Builder (TMB) fitting of VAST model\n#' @param Report list of TMB specifications for VAST model\n#' @param DateFile path for directory housing VAST model and output figures and objects\n#' @param Region string indicating region of evaluation, one of: Gulf_of_Alaska, Eastern_Bering_Sea, or Aleutian_Islands\n#' @param TmbData list of TMB inputs for VAST model\n#' @param Data_Geostat dataframe containing RACE bottom trawl survey data\n#' @param Extrapolation_List list object containing definition of for which density extrapolation is conducted when calculating indices\n#' @param Spatial_List tagged list with spatial information needed for Data_Fn\n#'\n#' @return A series of output figures exploring model diagnostics, density predictions, and indices.\n#' @export\nplot_VAST_output <- function(Opt, Report, DateFile, Region, TmbData, Data_Geostat, Extrapolation_List, Spatial_List) {\n  \n  #========================================================================\n  ##### DIAGNOSTIC PLOTS #####\n  \n  #Plot spatial distribution of data\n  SpatialDeltaGLMM::Plot_data_and_knots(Extrapolation_List = Extrapolation_List,\n                                        Spatial_List = Spatial_List, Data_Geostat = Data_Geostat,\n                                        PlotDir = DateFile)\n  \n  #Diagnostics for Encounter Probability\n  #  \"Diag--Encounter_prob\"\n  Enc_prob = SpatialDeltaGLMM::Check_encounter_prob(Report = Report,\n                                                    Data_Geostat = Data_Geostat,\n                                                    DirName = DateFile)\n  \n  #Diagnostics for positive-catch-rate component\n  Q = SpatialDeltaGLMM::QQ_Fn(TmbData = TmbData, Report = Report,\n                              FileName_PP = paste0(DateFile, \"Posterior_Predictive.jpg\"),\n                              FileName_Phist = paste0(DateFile, \"Posterior_Predictive-Histogram.jpg\"),\n                              FileName_QQ = paste0(DateFile, \"Q-Q_plot.jpg\"),\n                              FileName_Qhist = paste0(DateFile, \"Q-Q_hist.jpg\"))\n  \n  \n  #Diagnostics for plotting residuals on a map\n  \n  \n  MapDetails_List = SpatialDeltaGLMM::MapDetails_Fn( \"Region\"=Region,\n                                                     \"NN_Extrap\"=Spatial_List$PolygonList$NN_Extrap,\n                                                     \"Extrapolation_List\"=Extrapolation_List )\n  \n  #Which Years to Include\n  Year_Set = seq(min(Data_Geostat[,'Year']),max(Data_Geostat[,'Year']))\n  Years2Include = which( Year_Set %in% sort(unique(Data_Geostat[,'Year'])))\n  \n  #Or just include years with observations\n  # Year_Set = y\n  # Years2Include = which( Year_Set %in% sort(unique(Data_Geostat[,'Year'])))\n  \n  #Plot Pearson Residuals\n  #  Look for spatial patterns-- indication of \"overshrinking\"\n  #  Creates \"maps--\" files\n  SpatialDeltaGLMM:::plot_residuals(Lat_i = Data_Geostat[,\"Lat\"], Lon_i = Data_Geostat[, \"Lon\"], TmbData = TmbData,\n                                    Report = Report, Q = Q, savedir = DateFile, MappingDetails = MapDetails_List[[\"MappingDetails\"]],\n                                    PlotDF = MapDetails_List[[\"PlotDF\"]], MapSizeRatio = MapDetails_List[[\"MapSizeRatio\"]],\n                                    Xlim = MapDetails_List[[\"Xlim\"]], Ylim = MapDetails_List[[\"Ylim\"]],\n                                    FileName = DateFile, Year_Set = Year_Set, Years2Include = Years2Include,\n                                    Rotate = MapDetails_List[[\"Rotate\"]], Cex = MapDetails_List[[\"Cex\"]],\n                                    Legend = MapDetails_List[[\"Legend\"]], zone = MapDetails_List[[\"Zone\"]],\n                                    mar = c(0, 0, 2, 0), oma = c(3.5, 3.5, 0, 0), cex = 1.8)\n  \n  \n  \n  \n  #========================================================================\n  ##### MODEL OUTPUT PLOTS #####\n  \n  #Direction of \"geometric anisotropy\"\n  SpatialDeltaGLMM::PlotAniso_Fn(FileName = paste0(DateFile,\"Aniso.png\"),\n                                 Report = Report, TmbData = TmbData)\n  \n  #Density Surface for Each Year -- \"Dens\"\n  SpatialDeltaGLMM::PlotResultsOnMap_Fn(plot_set = c(3),\n                                        MappingDetails = MapDetails_List[[\"MappingDetails\"]],\n                                        Report = Report, Sdreport = Opt$SD, PlotDF = MapDetails_List[[\"PlotDF\"]],\n                                        MapSizeRatio = MapDetails_List[[\"MapSizeRatio\"]],\n                                        Xlim = MapDetails_List[[\"Xlim\"]], Ylim = MapDetails_List[[\"Ylim\"]],\n                                        FileName = DateFile, Year_Set = Year_Set, Years2Include = Years2Include,\n                                        Rotate = MapDetails_List[[\"Rotate\"]], Cex = MapDetails_List[[\"Cex\"]],\n                                        Legend = MapDetails_List[[\"Legend\"]], zone = MapDetails_List[[\"Zone\"]],\n                                        mar = c(0, 0, 2, 0), oma = c(3.5, 3.5, 0, 0), cex = 1.8,\n                                        plot_legend_fig = TRUE)\n  \n  \n  \n  #Generate Index of Abundance\n  \n  Index = SpatialDeltaGLMM::PlotIndex_Fn(DirName = DateFile,\n                                         TmbData = TmbData, Sdreport = Opt[[\"SD\"]],\n                                         Year_Set = Year_Set,\n                                         Years2Include = Years2Include, \n                                         use_biascorr = TRUE)\n  \n  # idx <- Index$Table\n  # \n  # \n  # #Plotting \n  # x.lim <- c(min(yrs.surv), max(yrs.surv))\n  # up.sd <- idx$Estimate_metric_tons + idx$SD_mt\n  # low.sd <- idx$Estimate_metric_tons - idx$SD_mt\n  # y.lim <- c(min(low.sd), max(up.sd))\n  # \n  # loc.yrs <- which(idx$Year %in% yrs.surv)\n  # \n  # \n  # plot(x=NULL, y=NULL, xlim=x.lim, ylim=y.lim, ylab='Survey Estimate (metric Tons)', xlab='Year',\n  #      main='Gulf of Alaska\\nNorthern Rockfish Survey Index')\n  # \n  # polygon(x=c(yrs.surv, rev(yrs.surv)), y=c(low.sd[loc.yrs],rev(up.sd[loc.yrs])), col='lightgray', border=FALSE)\n  # lines(x=yrs.surv, y=idx$Estimate_metric_tons[loc.yrs], col='red')\n  # points(x=yrs.surv, y=idx$Estimate_metric_tons[loc.yrs], pch=21, bg='red')\n  # grid(col='black')\n  \n  \n  #Center of gravity and range expansion/contraction\n  #  For some reason I can't actually change the years to plot \n  SpatialDeltaGLMM::Plot_range_shifts(Report = Report,\n                                      TmbData = TmbData, Sdreport = Opt[[\"SD\"]], Znames = colnames(TmbData$Z_xm),\n                                      PlotDir = DateFile, Year_Set = Year_Set)\n  \n  \n}\n",
    "created" : 1490831188697.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "13|118|124|0|\n",
    "hash" : "3397139301",
    "id" : "3B6BFA6B",
    "lastKnownWriteTime" : 1490837866,
    "last_content_update" : 1490837866538,
    "path" : "~/Projects/VAST Evaluation/AFSC_VAST_Evaluation/R/plot-VAST-output.r",
    "project_path" : "R/plot-VAST-output.r",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 6,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_source"
}